{include file='index/header' /}
<style>
	.toolbar {
		margin-left: -6px;
		/* width: 55%; */
		float: left;
		/* border: 1px solid #ccc; */
	}

	.text {
		border: 1px solid #ccc;
		min-height: 100px;
	}

	.box-main .massageText {
		float: left;
	}

	.w-e-panel-tab-content {
		height: 249px;
	}
	.music {
		background: #f1f3f4;
	}
</style>
<div class="main">
	<div class="contents">
		{if $userInfo.isSiteUser}
		<div class="post" id="postform" style="display:block;">
			<div class="postad" id="wcontent">&nbsp;</div>

			<div id="msgInput" class="text" maxlength="1400" onkeyup="check_len1()">
				<!-- <p>你在做什么呢</p> -->
			</div>
			<div class="postnow">
				<span>
					<input type="button" value="发布" class="button layui-btn layui-btn" id="button" />
				</span>
				你还可以发布<em id="leftlen1">1400</em>字
			</div>

			<!-- 表情等 -->
			<div id="msgToolBar" class="toolbar"></div>
			<div class="tool-class" style="display: none;">
				<div class="imgHtml" style="display: block;border-radius: 3px;">
					<!-- <img src="" width="70px" alt=""> -->
					上传成功！
					<i class="layui-icon layui-icon-close-fill" onclick="removeImg(this)"
						style="color: red;cursor:pointer;font-size:20px!important"></i>
				</div>
				<input type="hidden" id="imgVal">
			</div>
			<div class="clear"></div>
		</div>
		{else}
		<div class="top"></div>
		{/if}
		<input type="hidden" id="userInfo" value="{$userInfo|json_encode}" />
		<div class="sendMsg"></div>
		<div id="msgContent">
			{if isset($userMessage[0])}
			{foreach $userMessage as $message}
			<div class="entry">
				<div class="avatar">
					<div class="imgborder"><a href="{:url('/'.$message.blog.'/')}"><img
								src="{$message.head_image}" /></a></div>
				</div>
				<div class="box box-main">
					<p class="massageText">
						<a href="{:url('/'.$message.blog.'/own/')}" id="nickname">{$message.nickname}：
						</a>
						{$message.contents|raw}{$message.repost|raw}
					</p>
					{if $message.image}
					{if json_decode($message.image_info, true)['image_type'] == 'mp4'}
					<p class="massageImg clear" vid="{$message.image}"><video width="400px" controls="" name="media">
							<source src="{$message.image}" type="video/mp4">
						</video></p>
					{else}
					<p class="massageImg clear"><img width="75%" , src="{:getTypeImg($message.image_info)}"
							onclick="showMessageImg(this)" style="cursor:pointer;"></p>
					{/if}
					{/if}
					<div class="static clear">
						<span>
							<a href="{:url('/'.$message.blog.'/'.'message/'.$message.msg_id)}">查看</a> |
							<a href="javascript:void(0);"
								onclick="repost(this, {$message.uid}, {$message.msg_id})">转发{if 0 !=
								$message.repostsum}（{$message.repostsum}）{/if}</a> |
							<a href="javascript:void(0);" onclick="comment({$message.msg_id}, {$message.uid});">评论{if 0
								!=
								$message.commentsum}（{$message.commentsum}）{/if}</a>
							{if $userInfo.isSiteUser && request()->action()=='own'}
							| <a href="{:url('/'.$message.blog.'/'.'del/message/'.$message.msg_id)}">删除</a>
							{/if}
						</span>
						{$message.ctime|setMessageTime} 来自 {$message.refrom}
					</div>
				</div>
				<div class="clear"></div>
			</div>
			{/foreach}
			{else}
			<!-- <div class="entry">
				<div class="box">
					<p>暂无微博...</p>
				</div>
				<div class="clear"></div>
			</div> -->
			{/if}
		</div>
		<div id="showMore">

		</div>
	</div>
	{if $userInfo.isSiteUser}
	{include file='index/sidebar_index' /}
	{else}
	{include file='index/sidebar_user' /}
	{/if}

	{include file='index/footer' /}
	<script>
		//字符串转换为时间戳
		function getDateTimeStamp(dateStr) {
			return dateStr + '000'
			return Date.parse(dateStr.replace(/-/gi, "/"));
		}
		function getDateDiff(dateStr) {
			var publishTime = getDateTimeStamp(dateStr) / 1000,
				d_seconds,
				d_minutes,
				d_hours,
				d_days,
				timeNow = parseInt(new Date().getTime() / 1000),
				d,

				date = new Date(publishTime * 1000),
				Y = date.getFullYear(),
				M = date.getMonth() + 1,
				D = date.getDate(),
				H = date.getHours(),
				m = date.getMinutes(),
				s = date.getSeconds();
			//小于10的在前面补0
			if (M < 10) {
				M = '0' + M;
			}
			if (D < 10) {
				D = '0' + D;
			}
			if (H < 10) {
				H = '0' + H;
			}
			if (m < 10) {
				m = '0' + m;
			}
			if (s < 10) {
				s = '0' + s;
			}

			d = timeNow - publishTime;
			d_days = parseInt(d / 86400);
			d_hours = parseInt(d / 3600);
			d_minutes = parseInt(d / 60);
			d_seconds = parseInt(d);

			if (d_days > 0 && d_days < 3) {
				return d_days + '天前';
			} else if (d_days <= 0 && d_hours > 0) {
				return d_hours + '小时前';
			} else if (d_hours <= 0 && d_minutes > 0) {
				return d_minutes + '分钟前';
			} else if (d_seconds < 60) {
				if (d_seconds <= 0) {
					return '刚刚';
				} else {
					return d_seconds + '秒前';
				}
			} else if (d_days >= 3 && d_days < 30) {
				return M + '-' + D + '&nbsp;' + H + ':' + m;
			} else if (d_days >= 30) {
				return Y + '-' + M + '-' + D + '&nbsp;' + H + ':' + m;
			}
		}
		var page = 0;
		$(function () {
			var canLoad = true
			function initNextPage(url) {
				if (!canLoad) return
				page++
				canLoad = false
				var url = window.location.pathname
				$.ajax({
					type: "get",
					url: url,
					data: { page: page },
					dataType: "json",
				})
					.done(function (json) {
						var data = json.data.data
						console.log(data)
						if (!data) return
						for (var i = 0; i < data.length; i++) {
							var mediaStr = '';
							var str = '';
							var delStr = '';
							var c1 = '';
							var c2  = '';
							if (data[i].image) {
								data[i].image_info = $.parseJSON(data[i].image_info)
								if (data[i].image_info.image_type == 'mp4') {
									mediaStr = '<p class="massageImg clear showVideo' + data[i].msg_id + '" vid="' + data[i].image + '"><video width="400px"  controls=""  name="media"><source src="" type="video/mp4"></video></p>';
								} else {
									mediaStr = '<p  class="massageImg clear"><img width="75%"  onclick="showMessageImg(this)" src="' + data[i].image + '"></p>';
								}
							}
							// if (0 != data[i].repostsum) {
							// 	c1 = '('+data[i].repostsum+')'
							// }
							if (0 != data[i].commentsum) {
								c2 = '('+data[i].commentsum+')'
							}
							delStr += '<a href="/'+ data[i].blog + '/message/'+ data[i].msg_id + '">查看</a> | ';
							// delStr += '<a href="javascript:void(0);" onclick="repost(this, '+data[i].uid+', '+data[i].msg_id+')">转发'+c1+'</a> |';
							delStr += '<a href="javascript:void(0);" onclick="comment('+data[i].msg_id+', '+data[i].uid+');">评论'+c2+'</a>';
							
							if (json.data.allow_delete) {
								delStr += ' | <a href="/' + data[i].blog + '/del/message/' + data[i].msg_id + '">删除</a>';
							}
							str = '<div class="entry"><div class="avatar"><div class="imgborder"><a href="/' + data[i].blog + '/own/"><img src="' + data[i].head_image + '" /></a></div></div><div class="box box-main"><p class="massageText"><a href="/' + data[i].blog + '/own/">' + data[i].nickname + '：</a>' + data[i].contents + data[i].repost + '</p>' + mediaStr + '<div class="static clear"><span>'+delStr+'</span>' + getDateDiff(data[i].ctime) + ' 来自 ' + data[i].refrom + '</div></div><div class="clear"></div></div>';
							$("#msgContent").append(str);
							iniVideo(data[i].msg_id)
						}
						canLoad = true
					})
					.always(function () {
					})
					.fail(function () {
					});
			}
			$(window).scroll(function () {
				var top = $(window).scrollTop();
				var winH = $(window).height();
				var docH = $(document).height();
				if (docH <= (top + winH + 200)) {
					initNextPage(page)
				}
			});
			initNextPage(page)
		})

	</script>